<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <title>DG-Panel</title>
    <link rel="stylesheet" href="mdui/css/mdui.min.css" />
</head>
<body class="mdui-appbar-with-toolbar mdui-color-grey-100 mdui-appbar-with-tab" >
    <div class="mdui-appbar mdui-appbar-fixed mdui-color-indigo">
        <div class="mdui-toolbar">
            <div class="mdui-typo-headline">DG-Panel</div>
            <div class="mdui-toolbar-spacer"></div>
            <a href="live.html" class="mdui-btn mdui-btn-icon mdui-ripple" mdui-tooltip="{content: '观看直播'}" onclick="demo()">
                <i class="mdui-icon material-icons">live_tv</i>
            </a>
            <button class="mdui-btn mdui-btn-icon mdui-ripple" mdui-tooltip="{content: '演示模式'}" onclick="demo()">
                <i class="mdui-icon material-icons">airplay</i>
            </button>
        </div>
        <div class="mdui-tab mdui-color-theme" mdui-tab>
            <a href="index.html" class="mdui-ripple mdui-ripple-white mdui-tab-active">郊狼</a>
            <a href="" class="mdui-ripple mdui-ripple-white">咕咕咕</a>
        </div>
    </div>
    <div class="mdui-color-white mdui-card mdui-shadow-3" style="margin: 2%;">
        <div class="mdui-card-primary">
            <div class="mdui-card-primary-title">服务器状态</div>
            <div class="mdui-card-primary-subtitle">
                <div id="usernum"> 在线人数: 获取中</div>
            </div>
    </div>
        <div class="mdui-card-content">
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">后端服务器地址</label>
                <input id='server' class="mdui-textfield-input" type="text" placeholder="wss://dgconnect.cloudreflection.eu.org:8443"/>
            </div>
            <div class="mdui-typo-subheading" style="display: inline-block;">您与服务器的连接: </div>
            <div class="mdui-typo-subheading" style="display: inline-block;color: gray;" id="userconn">连接中</div>
            <button class="mdui-btn mdui-btn-icon mdui-ripple" mdui-tooltip="{content: '重新连接'}" onclick="connectws();"><i class="mdui-icon material-icons">refresh</i></button>
            <div></div>
            <div class="mdui-typo-subheading" style="display: inline-block;">服务器与设备的连接: </div>
            <div class="mdui-typo-subheading" style="display: inline-block;color: red;" id="serverconn">未连接</div>
        </div>
    </div>
    <div class="mdui-color-white mdui-card mdui-shadow-3" style="margin: 2%;">
        <div class="mdui-card-primary">
            <div class="mdui-card-primary-title">郊狼控制台</div>
        </div>
        <div class="mdui-card-content">
            <div class="mdui-valign">
                <div id="posa" style="display: inline-block;" class="mdui-typo-title">A通道: 位置</div>
                <div id="mina" style="display: inline-block;margin-left: 3%;" class="mdui-typo-subheading">0</div>
                <button id="rma" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="addstrenth(true,-1)" ondblclick="addstrenth(true,-2)">
                    <i class="mdui-icon material-icons">remove</i>
                </button>
                <div id="stra" style="display: inline-block;" class="mdui-typo-display-2">0</div>
                <button id="adda" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="addstrenth(true,1)" ondblclick="addstrenth(true,2)">
                    <i class="mdui-icon material-icons">add</i>
                </button>
                <div id="maxa" style="display: inline-block" class="mdui-typo-subheading">0</div>
                <button id="randa" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="randomstrenth(true)">
                    <i class="mdui-icon material-icons" mdui-tooltip="{content: '随机增减强度'}">swap_vert</i>
                </button>
            </div>
            <div class="mdui-valign" style="margin-top: 5%;">
                <div id="posb" style="display: inline-block;" class="mdui-typo-title">B通道: 位置</div>
                <div id="minb" style="display: inline-block;margin-left: 3%;" class="mdui-typo-subheading">0</div>
                <button  id="rmb" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="addstrenth(false,-1)" ondblclick="addstrenth(false,-2)">
                    <i class="mdui-icon material-icons">remove</i>
                </button>
                <div id="strb" style="display: inline-block;" class="mdui-typo-display-2">0</div>
                <button id="addb" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="addstrenth(false,1)" ondblclick="addstrenth(false,2)">
                    <i class="mdui-icon material-icons">add</i>
                </button>
                <div id="maxb" style="display: inline-block" class="mdui-typo-subheading">0</div>
                <button id="randb" class="mdui-btn mdui-btn-icon mdui-ripple" disabled onclick="randomstrenth(false)">
                    <i class="mdui-icon material-icons" mdui-tooltip="{content: '随机增减强度'}">swap_vert</i>
                </button>
            </div>
        </div>
    </div>
    <div class="mdui-color-white mdui-card mdui-shadow-3" style="margin: 2%;">
        <div class="mdui-card-primary">
            <div class="mdui-card-primary-title">关于 DG-Panel</div>
            <div class="mdui-card-content mdui-typo-body-1">
                <div>作者: <a href="https://t.me/cloudreflection">@cloudreflection</a></div>
                <div>捐赠(tron): TMQp7wRXDLJXJ7MmwaKGu9Po2jVAfWHfdq</div>
                <div>后端参见: <a href="https://github.com/cloudreflection/DG-Panel">https://github.com/cloudreflection/DG-Panel</a></div>
            </div>
        </div>
    </div>
    <script src="mdui/js/mdui.min.js"></script>
    <script>
        document.getElementById('server').value='wss://dgconnect.cloudreflection.eu.org:8443';
        var ws,maxa,maxb,mina,minb,strentha,strenthb,serverconn;
        function disablea(dis){
            document.getElementById('adda').disabled=document.getElementById('rma').disabled=document.getElementById('randa').disabled=dis;
        }
        function disableb(dis){
            document.getElementById('addb').disabled=document.getElementById('rmb').disabled=document.getElementById('randb').disabled=dis;
        }
        function connectws(){
            if(document.getElementById('server').value==''){document.getElementById('server').value='wss://dgconnect.cloudreflection.eu.org:8443';}
            try{if (ws.readyState == ws.OPEN){ws.close();}}catch(error){}
            document.getElementById('userconn').innerText = ('连接中');
            document.getElementById('userconn').style.color = 'gray';
            disablea(true);
            disableb(true);
            try{ws = new WebSocket(document.getElementById('server').value);}
            catch(error){
                document.getElementById('userconn').innerText = ('请检查服务器地址');
                document.getElementById('userconn').style.color = 'red';
                disablea(true);
                disableb(true);
                return;
            }
            ws.onopen = () => {
                document.getElementById('userconn').innerText = ('已连接');
                document.getElementById('userconn').style.color = 'green';
                disablea(false);
                disableb(false);
                ws.send(JSON.stringify({ type: 'init' }));
            }
            ws.onclose = () => {
                document.getElementById('userconn').innerText = ('未连接');
                document.getElementById('userconn').style.color = 'red';
                disablea(true);
                disableb(true);
                ws.close();
                return;
            }
            ws.onerror = () => {
                document.getElementById('userconn').innerText = ('未连接');
                document.getElementById('userconn').style.color = 'red';
                disablea(true);
                disableb(true);
                ws.close();
                return;
            }
            ws.onmessage = (rawData) => {
                const { data, type } = JSON.parse(rawData.data);
                switch (type) {
                    case 'init':
                        document.getElementById('usernum').innerText = ('在线人数: '+data.usernum);
                        maxa=data.maxa;
                        maxb=data.maxb;
                        mina=data.mina;
                        minb=data.minb;
                        strentha=data.strentha;
                        strenthb=data.strenthb;
                        if(data.strentha==-9){
                            strentha=0
                            disablea(true);
                        }else{disablea(false);}
                        if(data.strenthb==-9){
                            strenthb=0
                            disableb(true);
                        }else{disableb(false);}
                        if(data.serverconn==false){
                            document.getElementById('serverconn').innerText = ('未连接');
                            document.getElementById('serverconn').style.color = 'red';
                            disablea(true);
                            disableb(true);
                            serverconn=false;
                        }else{
                            document.getElementById('serverconn').innerText = ('已连接');
                            document.getElementById('serverconn').style.color = 'green';
                            disablea(false);
                            disableb(false);
                            serverconn=true;
                        }
                        document.getElementById('posa').innerText = ('A通道: '+data.anote);
                        document.getElementById('posb').innerText = ('B通道: '+data.bnote);
                        document.getElementById('mina').innerText = mina;
                        document.getElementById('minb').innerText = minb;
                        document.getElementById('maxa').innerText = maxa;
                        document.getElementById('maxb').innerText = maxb;
                        document.getElementById('stra').innerText = strentha;
                        document.getElementById('strb').innerText = strenthb;
                        break;
                    case 'update':
                        strentha=data.strentha;
                        strenthb=data.strenthb;
                        if(data.strentha==-9){
                            strentha=0
                            disablea(true);
                        }else{disablea(false);}
                        if(data.strenthb==-9){
                            strenthb=0
                            disableb(true);
                        }else{disableb(false);}
                        document.getElementById('stra').innerText = strentha;
                        document.getElementById('strb').innerText = strenthb;
                        if(data.serverconn==false){
                            document.getElementById('serverconn').innerText = ('未连接');
                            document.getElementById('serverconn').style.color = 'red';
                            serverconn=false;
                            disablea(true);
                            disableb(true);
                        }else{
                            document.getElementById('serverconn').innerText = ('已连接');
                            document.getElementById('serverconn').style.color = 'green';
                            serverconn=true;
                            disablea(false);
                            disableb(false);
                        }
                        document.getElementById('usernum').innerText = ('在线人数: '+data.usernum);
                        break;
                    }
                
            }
            }

        function addstrenth(side,stre){
            if(side){
                if(strentha+stre>maxa || strentha+stre<mina){return;}
            }else{
                if(strenthb+stre>maxb || strenthb+stre<minb){return;}
            }
            ws.send(JSON.stringify({'type':'addstrenth','data':{'side':side,'strenth': stre}}));
        }

        function randomstrenth(side){
            stre=Math.ceil(Math.random()*10);
            add=Math.round(Math.random());
            if(add==0){stre=stre*-1;}
            if(side){
                if(strentha+stre>maxa || strentha+stre<mina){
                    if(add=0){
                        stre=mina-strentha;
                    }else{
                        stre=maxa-strentha;
                    }
                }
            }else{
                if(strenthb+strb>maxb || strenthb+strb<minb){
                    if(add=0){
                        stre=mina-strenthb;
                    }else{
                        stre=maxb-strenthb;
                    }
                }
                ws.send(JSON.stringify({'type':'addstrenth','data':{'side':side,'strenth': stre}}));
        }

        function demo(){
            mdui.snackbar({
                message:'咕咕咕',
                position:'top'
            });
        }

        connectws();
    </script>
</body>